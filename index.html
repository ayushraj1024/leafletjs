<html>
    <head>
        <title>MNNIT Cloud GIS</title>
        <link rel="icon" type="image/png" href="images/mnnit_logo_square.png">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <link rel="stylesheet" href="mapControl.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
        <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
        <link rel="stylesheet" href="node_modules/leaflet-loader/leaflet-loader.css"/>
        <script src="https://kit.fontawesome.com/387047fbfe.js" crossorigin="anonymous"></script>
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #map {
                height: 100%;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script>L_PREFER_CANVAS = true;</script>
        <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
        <script src="nativeToast.js"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
        <script src="Leaflet.draw-develop\src\draw\handler\Draw.Polygon.js"></script>
        <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
        <script src="usStatesData.js"></script>
        <script src="addLayer.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
        <script src="node_modules/leaflet-dialog/Leaflet.Dialog.js"></script>
        <script src="node_modules/leaflet-notifications/js/leaflet-notifications.js"></script>
        <!--<script src="outTurf.js"></script>-->
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <script src='node_modules/leaflet-loader/leaflet-loader.js'></script>
        <!--<input style="margin-left: 10px;" type="button" id="Btn1" value="Add New Layer" onclick="showToast('You added a layer');" class="btnStyle span3"/>
        <input type="button" id="Btn2" value="Processing Toolbox" class="btnStyle span3"/>
        <input type="button" id="Btn3" value="Save" class="btnStyle span3"/>
        <input type="button" id="Btn4" value="Close" class="btnStyle span3"/>-->
        <div id="map"></div>

        <script>
            
            var layerList = [];
            var layerIndex = 0;
            var featureList = [];
            var toggleList = [];
            var layerNameList = [];
            var layerOrderList = [];
            var layerMultiplier = 1200;
            var attributeList = [];

            var map = L.map('map',{renderer: L.canvas(),zoomControl: false}).setView([25.320021, 82.973564], 12);

            var controlLoader = L.control.loader().addTo(map);

            //controlLoader.show();
            //controlLoader.hide();

            map.createPane((layerIndex+"_layer"));
            map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
            var OSMLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                pane: (layerIndex+"_layer"),
                attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            layerList.push(OSMLayer);
            layerNameList.push("OSM Standard");
            featureList.push(null);
            attributeList.push(null);
            toggleList.push(1);
            layerOrderList.push(layerIndex*layerMultiplier);

            //Add Title
            var mapTitle = L.control({position: 'topleft'});

            mapTitle.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mapTitle');
                this._div.innerHTML = ('<h1>MNNIT(2020GI07) Cloud GIS</h1>'); // create a div with a class "layers"
                return this._div;
            };
            mapTitle.addTo(map);

            //Add layer control
            var layerButtonControl = L.control({position: 'topleft'});
            var attributeTable = L.control({position: 'topleft'});
            var filterInput = L.control({position: 'topleft'});

            function showLayerAddingDialog() {
                document.getElementById("layeraddingdialogid").style.display = "block";
            }

            function hideLayerAddingDialog() {
                document.getElementById("layeraddingdialogid").style.display = "none";
            }

            function showProcessingToolbox() {
                document.getElementById("processingtoolboxid").style.display = "block";
            }

            function hideProcessingToolbox() {
                document.getElementById("processingtoolboxid").style.display = "none";
            }

            function hideAttributeTableDialog() {
                document.getElementById("attributetabledialogid").style.display = "none";
                //attributeTable.removeFrom(map);
            }

            function hideBufferDialog() {
                document.getElementById("bufferdialog").style.display = "none";
            }
            
            layerButtonControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mapbuttons'); // create a div with a class "layers"
                this._div.innerHTML = "<a href='#' class='maplinks' onclick='showLayerAddingDialog();'><h4 class='mapbutton'><b>Add New Layer</b></h4></a>&nbsp;&nbsp;<a href='#' class='maplinks'><h4 class='mapbutton' onclick='showProcessingToolbox();'><b>Processing Toolbox</b></h4></a>";
                return this._div;
            };
            layerButtonControl.addTo(map);


            //Add layer adding dialog box
            var layerAddingDialogBox = L.control({position: 'topright'});

            layerAddingDialogBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'layeraddingdialog');
                this._div.id = "layeraddingdialogid";
                this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideLayerAddingDialog();'>Close</a><br><h3>Add New Layer</h3><h4>Choose from the below layers:</h4><div class='inline'><a href='#' onclick='addPointLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Aschool_points_wgs84&maxFeatures=3451&outputFormat=application%2Fjson\")'>Varanasi School Points Data</a>&nbsp;<a href='#' onclick='navigator.clipboard.writeText(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Aschool_points_wgs84&maxFeatures=3451&outputFormat=application%2Fjson\");'><img src='images/svg/copy.svg' height=16 width=auto></img></a></div><br><br><div class='inline'><a href='#' onclick='addPolygonLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avillage_boundary_wgs84&outputFormat=application%2Fjson\")'>Varanasi Village Boundary</a>&nbsp;<a href='#' onclick='navigator.clipboard.writeText(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avillage_boundary_wgs84&outputFormat=application%2Fjson\")'><img src='images/svg/copy.svg' height=16 width=auto></img></a></div><br><br><div class='inline'><a href='#' onclick='addLineLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avaranasi_roads_wgs84&&outputFormat=application%2Fjson\")'>Varanasi Road Network</a><a href='#'><img src='images/svg/copy.svg' height=16 width=auto onclick='navigator.clipboard.writeText(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avaranasi_roads_wgs84&&outputFormat=application%2Fjson\")'></img></a></div>"
                + "<br><br><hr><h4>Or enter a custom OGC Webservice URL below:</h4>"
                + "<textarea type='text' placeholder='Enter OGC URL' id='ogcurl'></textarea>"
                + "<br><br><input placeholder='Enter a name for this layer' type='text' id='ogcname'/>"
                + "<h4>And then press one of the below buttons:</h4>"
                + "<button onclick='getInputValueAndImportPointLayerFromSDI();'>Point Layer</button>&nbsp;<button onclick='getInputValueAndImportLineLayerFromSDI();'>Line Layer</button>&nbsp;<button onclick='getInputValueAndImportPolygonLayerFromSDI();'>Polygon Layer</button>"
                + "<h5>To learn how to write OGC filters visit this link:</h5>"
                + "<a href='https://mapserver.gis.umn.edu/nl_NL/ogc/filter_encoding.html'>https://mapserver.gis.umn.edu/nl_NL/ogc/filter_encoding.html</a>";
                return this._div;
            };
            layerAddingDialogBox.addTo(map);

            //Add processing toolbox
            var processingToolbox = L.control({position: 'topright'});

            processingToolbox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'processingtoolbox');
                this._div.id = "processingtoolboxid";
                this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideProcessingToolbox();'>Close</a><br><h3>Processing Toolbox</h3><h4>Choose an operation below:</h4>"
                + "<a href='#' onclick='buffer();'>Buffer</a>";
                return this._div;
            };
            processingToolbox.addTo(map);

            //Add layer control
            var layerControl = L.control({position: 'bottomleft'});

            layerControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'layers'); // create a div with a class "layers"
                return this._div;
            };
            
            layerControl.addLayer = function (layer,layerName) {
                var currentLayer = this;
                (function (_layerIndex) {
                    currentLayer._div.innerHTML += ('<div class="layer_elements" id="'+ layerIndex +'_layer"><p><b>'+ layerName +'&nbsp;<a href="#" id="'+ layerIndex+"_delete" +'"><img src="images/svg/trash.svg" width=13></img></a>&nbsp;<a href="#"><img id="'+ layerIndex+"_toggle"+'" src="images/svg/eye.svg" width=13 ></img></a>&nbsp;<a href="#"><img id="'+ layerIndex +'_up" src="images/svg/arrow_up.svg" width=13 ></img></a>&nbsp;<a href="#"><img id="'+ layerIndex +'_down" src="images/svg/arrow_down.svg" width=13 ></img></a>&nbsp;<a href="#"><img id="'+ layerIndex +'_attributetable" src="images/svg/table.svg" width=13></img></a>&nbsp;<a href="#"><img id="'+ layerIndex + '_save" src="images/svg/save.svg" width=13></img></a></b></p></div>');
                })(layerIndex);
                console.log(layerList);
            };

            layerControl.addTo(map);
            layerControl.addLayer(OSMLayer,"OSM Standard");
            layerIndex++;

            function buffer() {
                var bufferDialog = L.control({position: 'topright'});
            
                var selectTag = "<label for='layers'>Selet a point layer:</label>"
                + "<select name='layers' id='layerselect'>";
                for(let i = 0;i < attributeList.length; i++)
                {
                    try {
                        //if(attributeList[i][0]["geometry"]["type"] == "Point") {
                            //console.log("Layer is a point layer");
                            selectTag = selectTag + "<option value='" + i + "'>"+ layerNameList[i] +"</option>";
                        //}
                    } catch(err) {
                        console.log(err);
                    }
                }
                selectTag = selectTag + "</select>";
                //console.log(attributeList[1][0]["properties"]["latitude"]);
                bufferDialog.onAdd = function (map) {
                    this._div = L.DomUtil.create('div', 'bufferdialog');
                    this._div.id = "bufferdialog";
                    this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideBufferDialog();'>Close</a>"
                    + "<br><h3>Buffer</h3>"
                    + "<h4>Select a point layer from below list</h4><br><br>"
                    + selectTag
                    + "<br><input type='text' id='bufferLayerName' placeholder='Give a name to this layer'/>"
                    + "<br><br><button onclick='startBuffer();'>Start Processing</button>";
                    return this._div;
                };
                bufferDialog.addTo(map);
            }

            function startBuffer() {
                var selectedLayerId = document.getElementById('layerselect').value;
                var bufferLayerName = document.getElementById('bufferLayerName').value;

                var bufferList = [];
                for(let i = 0; i < attributeList[selectedLayerId].length; i++) {
                    //var point = turf.point([attributeList[selectedLayerId][i]["properties"]["longitude"], attributeList[selectedLayerId][i]["properties"]["latitude"]]);
                    var buffered = turf.buffer(attributeList[selectedLayerId][i], 500, {units: 'meters'});
                    bufferList.push(buffered);
                }
                
                addPolygonLayerFromOperation(bufferList,bufferLayerName);

            }

            function getInputValueAndImportPointLayerFromSDI() {
                ogcURL = document.getElementById("ogcurl").value;
                ogcName = document.getElementById("ogcname").value;
                addPointLayerFromSDI(ogcURL,ogcName);
            }
            function getInputValueAndImportPolygonLayerFromSDI() {
                ogcURL = document.getElementById("ogcurl").value;
                ogcName = document.getElementById("ogcname").value;
                addPolygonLayerFromSDI(ogcURL,ogcName);
            }
            function getInputValueAndImportLineLayerFromSDI() {
                ogcURL = document.getElementById("ogcurl").value;
                ogcName = document.getElementById("ogcname").value;
                addLineLayerFromSDI(ogcURL,ogcName);
            }

            //Funtions for adding layers from operations instead of SDI >>>
            async function addPointLayerFromOperation(data,givenLayerName="Points") {
                var geojsonLayer;      
                var markers = [];
                var attributes = [];
                controlLoader.show();
                map.createPane((layerIndex+"_layer"));
                map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                geojsonLayer = L.geoJson(data, {
                    pointToLayer: function (feature, latlng) {
                        var marker = L.circleMarker(latlng,{pane: (layerIndex+"_layer"), radius:2,color: "#FF0000",});
                        var popupContent = "";
                        for (const property in feature.properties) {
                            popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                        }
                        var featurePane = map.createPane((layerIndex+"_layer_feature"));
                        featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                        marker.bindPopup(popupContent,{pane: featurePane});
                        markers.push(marker);
                        attributes.push(feature);
                        return marker;
                    },
                    onEachFeature: function (feature, layer) {
                        /*for (const property in feature.properties) {
                            console.log(`${property}: ${feature.properties[property]}`);
                        }*/
                        //console.log(feature.properties);
                    },
                    pane: (layerIndex+"_layer")
                }).addTo(map);
                    
                featureList.push(markers);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }

            async function addPolygonLayerFromOperation(data,givenLayerName="Polygons") {
                var geojsonLayer;      
                var polygons = [];
                var attributes = [];
                controlLoader.show();
                map.createPane((layerIndex+"_layer"));
                map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                geojsonLayer = L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                        var popupContent = "";
                        for (const property in feature.properties) {
                            popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                        }
                        var featurePane = map.createPane((layerIndex+"_layer_feature"));
                        featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                        layer.bindPopup(popupContent,{pane: featurePane});
                        attributes.push(feature);
                    },
                    pane: (layerIndex+"_layer")
                }).addTo(map);
                    
                featureList.push(null);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }

            async function addLineLayerFromOperation(data,givenLayerName="Lines") {
                var geojsonLayer;      
                var lines = [];
                var attributes = [];
                controlLoader.show();
                map.createPane((layerIndex+"_layer"));
                map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                geojsonLayer = L.geoJson(data, {
                    onEachFeature: function (feature,layer) {
                        var popupContent = "";
                        for (const property in feature.properties) {
                            popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                        }
                        var featurePane = map.createPane((layerIndex+"_layer_feature"));
                        featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                        attributes.push(feature);
                        layer.bindPopup(popupContent,{pane: featurePane});
                    },
                    pane: (layerIndex+"_layer")
                }).addTo(map);
                    
                featureList.push(null);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }
            //<<< Functions for adding layers from operations instead of SDI

            async function addPointLayerFromSDI(url,givenLayerName="Points") {
                var geojsonLayer;      
                var markers = [];
                var attributes = [];
                controlLoader.show();
                await $.getJSON(url)
                    .then(function (data) {
                        map.createPane((layerIndex+"_layer"));
                        map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                        geojsonLayer = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                var marker = L.circleMarker(latlng,{pane: (layerIndex+"_layer"), radius:2,color: "#FF0000",});
                                var popupContent = "";
                                for (const property in feature.properties) {
                                    popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                                }
                                var featurePane = map.createPane((layerIndex+"_layer_feature"));
                                featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                                marker.bindPopup(popupContent,{pane: featurePane});
                                markers.push(marker);
                                attributes.push(feature);
                                return marker;
                            },
                            onEachFeature: function (feature, layer) {
                                /*for (const property in feature.properties) {
                                    console.log(`${property}: ${feature.properties[property]}`);
                                }*/
                                //console.log(feature.properties);
                            },
                            pane: (layerIndex+"_layer")
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(markers);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }

            async function addPolygonLayerFromSDI(url,givenLayerName="Polygons") {
                var geojsonLayer;      
                var polygons = [];
                var attributes = [];
                controlLoader.show();
                await $.getJSON(url)
                    .then(function (data) {
                        map.createPane((layerIndex+"_layer"));
                        map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                        geojsonLayer = L.geoJson(data, {
                            onEachFeature: function (feature, layer) {
                                var popupContent = "";
                                for (const property in feature.properties) {
                                    popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                                }
                                var featurePane = map.createPane((layerIndex+"_layer_feature"));
                                featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                                layer.bindPopup(popupContent,{pane: featurePane});
                                attributes.push(feature);
                            },
                            pane: (layerIndex+"_layer")
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(null);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }

            async function addLineLayerFromSDI(url,givenLayerName="Lines") {
                var geojsonLayer;      
                var lines = [];
                var attributes = [];
                controlLoader.show();
                await $.getJSON(url)
                    .then(function (data) {
                        map.createPane((layerIndex+"_layer"));
                        map.getPane((layerIndex+"_layer")).style.zIndex = (layerIndex*layerMultiplier);
                        geojsonLayer = L.geoJson(data, {
                            onEachFeature: function (feature,layer) {
                                var popupContent = "";
                                for (const property in feature.properties) {
                                    popupContent = popupContent + "<br>" + `<b>${property}</b>: ${feature.properties[property]}`;
                                }
                                var featurePane = map.createPane((layerIndex+"_layer_feature"));
                                featurePane.style.zIndex = (layerIndex*layerMultiplier+100);
                                attributes.push(feature);
                                layer.bindPopup(popupContent,{pane: featurePane});
                            },
                            pane: (layerIndex+"_layer")
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(null);
                layerList.push(geojsonLayer);
                attributeList.push(attributes);
                toggleList.push(1);
                layerNameList.push(givenLayerName);
                layerOrderList.push(layerIndex*layerMultiplier);
                await layerControl.addLayer(geojsonLayer,givenLayerName);
                layerIndex++;
                addOnClickListenersToLayers();
                controlLoader.hide();
            }

            function download(content, fileName, contentType) {
                var a = document.createElement("a");
                var file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }

            function addOnClickListenersToLayers() {
                for(i = 0; i <= layerIndex; i++) {
                    deleteButton = document.getElementById(i+"_delete");
                    toggleButton = document.getElementById(i+"_toggle");
                    upButton = document.getElementById(i+"_up");
                    downButton = document.getElementById(i+"_down");
                    attributeTableButton = document.getElementById(i+"_attributetable");
                    saveButton = document.getElementById(i+"_save");
                    if (typeof window.addEventListener === 'function'){
                        (function (_deleteButton,_toggleButton,_upButton,_downButton,_attributeTableButton,_saveButton,_i) {
                            try {
                                _attributeTableButton.addEventListener('click',function(){
                                   
                                    attributeTable.onAdd = function (map) {
                                        this._div = L.DomUtil.create('div', 'attributetabledialog');
                                        this._div.id = "attributetabledialogid";
                                        if(attributeList[_i] == null) {
                                            this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideAttributeTableDialog();'>Close</a><br><h3>Attribute Table</h3><h4>The chosen layer has the following attribute data:</h4>No Attributes";
                                        } else {
                                            var k;
                                            var table = "<table><thead><tr>";
                                            for (const property in attributeList[_i][0].properties) {
                                                table = table + "<th>" + `${property}`+ "</th>";
                                            }
                                            table = table + "</tr></thead><tbody>";
                                            for(k = 0; k < attributeList[_i].length; k++) {
                                                table = table + "<tr>";
                                                for (const property in attributeList[_i][k].properties) {
                                                    table = table + "<td>" + `${attributeList[_i][k].properties[property]}` + "</td>";
                                                }
                                                table = table + "</tr>";
                                            }
                                            table = table + "</table>";
                                            this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideAttributeTableDialog();'>Close</a><br><h3>Attribute Table</h3><h4>The chosen layer has the following attribute data:</h4>" + table;
                                        }
                                        
                                        return this._div;
                                    };
                                    attributeTable.addTo(map);

                                    document.getElementById("attributetabledialogid").style.display = "block";
                                    
                                });
                                _saveButton.addEventListener('click',function(){
                                    if(attributeList[_i] != null) {
                                        download(JSON.stringify(attributeList[_i]), 'file'+_i+'.geojson', 'text/plain');
                                    } else {
                                        swal({
                                        title: "Support for raster layer downloading coming soon.",
                                        icon: "warning",
                                        });
                                    }
                                    console.log("save button clicked");
                                });
                                _upButton.addEventListener('click', function(){
                                    console.log(_i+"_layer");
                                    var zIndexOfCurrentLayer = map.getPane((_i+"_layer")).style.zIndex;
                                    var indexOfUpperLayer;
                                    var zIndexOfUpperLayer;
                                    var higherIndexFound = false;
                                    var allUpperOrderIndices = [];
                                    for (let j = 0; j < layerOrderList.length; j++) {
                                        if(layerOrderList[j] > zIndexOfCurrentLayer) {
                                            allUpperOrderIndices.push(j);
                                        } 
                                    }
                                    var min = layerOrderList[allUpperOrderIndices[(allUpperOrderIndices.length-1)]];
                                    console.log("Value of all upper order indices array is: "+allUpperOrderIndices.length);
                                    for(let k = 0; k < allUpperOrderIndices.length; k++) {
                                        console.log(layerOrderList[allUpperOrderIndices[k]]);
                                        if(layerOrderList[allUpperOrderIndices[k]] <= min) {
                                            min = layerOrderList[allUpperOrderIndices[k]];
                                            higherIndexFound = true;
                                            console.log("Higher index is: "+min);
                                        }
                                    }
                                    indexOfUpperLayer = layerOrderList.indexOf(min);
                                    zIndexOfUpperLayer = min;
                                    //indexOfUpperLayer = layerOrderList.indexOf(zIndexOfUpperLayer);
                                    console.log("Z Index Of Current Layer: "+zIndexOfCurrentLayer);
                                    console.log("Z Index Of Upper Layer: "+zIndexOfUpperLayer);
                                    console.log("Index of current layer: "+_i);
                                    console.log("Index of upper layer: "+indexOfUpperLayer);
                                    if(higherIndexFound) {
                                        
                                        map.getPane((_i+"_layer")).style.zIndex = zIndexOfUpperLayer;
                                        map.getPane(((indexOfUpperLayer)+"_layer")).style.zIndex = zIndexOfCurrentLayer;

                                        innerHTML1 = document.getElementById(_i+"_layer").innerHTML;
                                        console.log("Inner HTML 1: "+innerHTML1);

                                        innerHTML2 = document.getElementById((indexOfUpperLayer)+"_layer").innerHTML;
                                        console.log("Inner HTML 2: "+innerHTML2);

                                        document.getElementById(_i+"_layer").innerHTML = innerHTML2;
                                        document.getElementById((indexOfUpperLayer)+"_layer").innerHTML = innerHTML1;
                                        
                                        var currentLayerDOM = document.getElementById(_i+"_layer");
                                        var upperLayerDOM = document.getElementById((indexOfUpperLayer)+"_layer")
                                        
                                        currentLayerDOM.setAttribute("id",(indexOfUpperLayer+"_layer"));
                                        upperLayerDOM.setAttribute("id",(_i+"_layer"));

                                        layerOrderList[(_i)] = zIndexOfUpperLayer;
                                        layerOrderList[(indexOfUpperLayer)] = zIndexOfCurrentLayer;

                                        for(let l = 0; l < layerIndex; l++){
                                           var lDeleteButton = document.getElementById(l+"_delete");
                                           var lToggleButton = document.getElementById(l+"_toggle");
                                           var lUpButton = document.getElementById(l+"_up");
                                           var lDownButton = document.getElementById(l+"_down");
                                           lDeleteButton.replaceWith(lDeleteButton.cloneNode(true));
                                           lToggleButton.replaceWith(lToggleButton.cloneNode(true));
                                           lUpButton.replaceWith(lUpButton.cloneNode(true));
                                           lDownButton.replaceWith(lDownButton.cloneNode(true));
                                        }

                                        addOnClickListenersToLayers();
                                        console.log("Layer moved up");

                                    }
                                    
                                });
                                _downButton.addEventListener('click', function(){
                                    console.log(_i+"_layer");
                                    var zIndexOfCurrentLayer = map.getPane((_i+"_layer")).style.zIndex;
                                    var indexOfLowerLayer;
                                    var zIndexOfLowerLayer;
                                    var lowerIndexFound = false;
                                    var allLowerOrderIndices = [];
                                    for (let j = 0; j < layerOrderList.length; j++) {
                                        if(layerOrderList[j] < zIndexOfCurrentLayer) {
                                            allLowerOrderIndices.push(j);
                                        } 
                                    }
                                    var max = -1;
                                    console.log("Value of all lower order indices array is: "+allLowerOrderIndices.length);
                                    for(let k = 0; k < allLowerOrderIndices.length; k++) {
                                        console.log(layerOrderList[allLowerOrderIndices[k]]);
                                        if(layerOrderList[allLowerOrderIndices[k]] > max) {
                                            max = layerOrderList[allLowerOrderIndices[k]];
                                            lowerIndexFound = true;
                                            console.log("Lower index is: "+max);
                                        }
                                    }
                                    indexOfLowerLayer = layerOrderList.indexOf(max);
                                    zIndexOfLowerLayer = max;
                                    //indexOfLowerLayer = layerOrderList.indexOf(zIndexOfLowerLayer);
                                    console.log("Z Index Of Current Layer: "+zIndexOfCurrentLayer);
                                    console.log("Z Index Of Lower Layer: "+zIndexOfLowerLayer);
                                    console.log("Index of current layer: "+_i);
                                    console.log("Index of lower layer: "+indexOfLowerLayer);
                                    if(lowerIndexFound) {
                                        
                                        map.getPane((_i+"_layer")).style.zIndex = zIndexOfLowerLayer;
                                        map.getPane(((indexOfLowerLayer)+"_layer")).style.zIndex = zIndexOfCurrentLayer;

                                        innerHTML1 = document.getElementById(_i+"_layer").innerHTML;
                                        console.log("Inner HTML 1: "+innerHTML1);

                                        innerHTML2 = document.getElementById((indexOfLowerLayer)+"_layer").innerHTML;
                                        console.log("Inner HTML 2: "+innerHTML2);

                                        document.getElementById(_i+"_layer").innerHTML = innerHTML2;
                                        document.getElementById((indexOfLowerLayer)+"_layer").innerHTML = innerHTML1;
                                        
                                        var currentLayerDOM = document.getElementById(_i+"_layer");
                                        var lowerLayerDOM = document.getElementById((indexOfLowerLayer)+"_layer");
                                        
                                        currentLayerDOM.setAttribute("id",(indexOfLowerLayer+"_layer"));
                                        lowerLayerDOM.setAttribute("id",(_i+"_layer"));

                                        layerOrderList[(_i)] = zIndexOfLowerLayer;
                                        layerOrderList[(indexOfLowerLayer)] = zIndexOfCurrentLayer;

                                        for(let l = 0; l < layerIndex; l++){
                                           var lDeleteButton = document.getElementById(l+"_delete");
                                           var lToggleButton = document.getElementById(l+"_toggle");
                                           var lUpButton = document.getElementById(l+"_up");
                                           var lDownButton = document.getElementById(l+"_down");
                                           lDeleteButton.replaceWith(lDeleteButton.cloneNode(true));
                                           lToggleButton.replaceWith(lToggleButton.cloneNode(true));
                                           lUpButton.replaceWith(lUpButton.cloneNode(true));
                                           lDownButton.replaceWith(lDownButton.cloneNode(true));
                                        }

                                        addOnClickListenersToLayers();
                                        console.log("Layer moved down");

                                    }
                                 
                                });
                                _toggleButton.addEventListener('click', function(){
                                    if(toggleList[_i] == 1) {
                                        map.removeLayer(layerList[_i]);
                                        _toggleButton.setAttribute('src',"images/svg/eye-off.svg");
                                        if(featureList[_i] != null) {
                                            for(index=0;index < featureList[_i].length;index++) {
                                                    map.removeLayer(featureList[_i][index]);
                                                }
                                        }
                                        toggleList[_i] = 0;
                                    } else if(toggleList[_i] == 0) {
                                        layerList[_i].addTo(map);
                                        _toggleButton.setAttribute('src',"images/svg/eye.svg");
                                        if(featureList[_i] != null) {
                                            for(index=0;index < featureList[_i].length;index++) {
                                                featureList[_i][index].addTo(map);
                                                }
                                        }
                                        toggleList[_i] = 1;
                                    }
                                    console.log("Layer Visibility Toggled");
                                });
                                _deleteButton.addEventListener('click', function(){
                                    swal({
                                        title: "Are you sure you want to delete this layer?",
                                        icon: "warning",
                                        buttons: true,
                                        dangerMode: true,
                                        })
                                        .then((willDelete) => {
                                        if (willDelete) {
                                            if(toggleList[_i] == 1) {
                                                map.removeLayer(layerList[_i]);
                                                layerOrderList[(_i)] = ((-1)*(_i));
                                                console.log(featureList[_i]);
                                                if(featureList[_i] != null) {
                                                    for(index=0;index < featureList[_i].length;index++) {
                                                        map.removeLayer(featureList[_i][index]);
                                                        //featureList[_i].splice(index,1);
                                                    }
                                                }
                                            }
                                            //featureList.splice(_i,1);
                                            //layerList.splice(_i,1);
                                            //layerIndex--;
                                            var layer = document.getElementById(_i+"_layer").remove();
                                            //addOnClickListenersToLayers();
                                            swal("Layer has been deleted", {
                                            icon: "success",
                                            });
                                        }
                                    });
                                });
                        } catch(err) {
                            console.log(err);
                        }
                        })(deleteButton,toggleButton,upButton,downButton,attributeTableButton,saveButton,i);
                    }
                }
        }

        async function addAllLayersToMapAndUI() {
            map.eachLayer(function (layer) {
                map.removeLayer(layer);
            });
            
        }

        addOnClickListenersToLayers();
            
        </script>
    </body>
</html>