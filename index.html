<html>
    <head>
        <title>Leaflet.js Map</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <link rel="stylesheet" href="mapControl.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
        <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
        <script src="https://kit.fontawesome.com/387047fbfe.js" crossorigin="anonymous"></script>
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #map {
                height: 100%;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script>L_PREFER_CANVAS = true;</script>
        <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
        <script src="nativeToast.js"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
        <script src="Leaflet.draw-develop\src\draw\handler\Draw.Polygon.js"></script>
        <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
        <script src="usStatesData.js"></script>
        <script src="addLayer.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
        <script src="node_modules/leaflet-dialog/Leaflet.Dialog.js"></script>
        <script src="node_modules/leaflet-notifications/js/leaflet-notifications.js"></script>
        <!--<input style="margin-left: 10px;" type="button" id="Btn1" value="Add New Layer" onclick="showToast('You added a layer');" class="btnStyle span3"/>
        <input type="button" id="Btn2" value="Processing Toolbox" class="btnStyle span3"/>
        <input type="button" id="Btn3" value="Save" class="btnStyle span3"/>
        <input type="button" id="Btn4" value="Close" class="btnStyle span3"/>-->
  
        <div id="map"></div>

        <script>

            var layerList = [];
            var layerIndex = 0;
            var featureList = [];

            var map = L.map('map',{renderer: L.canvas(),zoomControl: false}).setView([25.320021, 82.973564], 12);

            var OSMLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            featureList.push(null);

            //Add Title
            var mapTitle = L.control({position: 'topleft'});

            mapTitle.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mapTitle');
                this._div.innerHTML = ('<h1>MNNIT(2020GI07) Cloud GIS</h1>'); // create a div with a class "layers"
                return this._div;
            };
            mapTitle.addTo(map);

            //Add layer control
            var layerButtonControl = L.control({position: 'topleft'});

            function showLayerAddingDialog() {
                document.getElementById("layeraddingdialogid").style.display = "block";
            }

            function hideLayerAddingDialog() {
                document.getElementById("layeraddingdialogid").style.display = "none";
            }

            function showProcessingToolbox() {
                document.getElementById("processingtoolboxid").style.display = "block";
            }

            function hideProcessingToolbox() {
                document.getElementById("processingtoolboxid").style.display = "none";
            }
            
            layerButtonControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mapbuttons'); // create a div with a class "layers"
                this._div.innerHTML = "<a href='#' class='maplinks' onclick='showLayerAddingDialog();'><h4 class='mapbutton'><b>Add New Layer</b></h4></a>&nbsp;&nbsp;<a href='#' class='maplinks'><h4 class='mapbutton' onclick='showProcessingToolbox();'><b>Processing Toolbox</b></h4></a>";
                return this._div;
            };
            layerButtonControl.addTo(map);


            //Add layer adding dialog box
            var layerAddingDialogBox = L.control({position: 'topright'});

            layerAddingDialogBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'layeraddingdialog');
                this._div.id = "layeraddingdialogid";
                this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideLayerAddingDialog();'>Close</a><br><h3>Add New Layer</h3><h4>Choose from the below layers:</h4><a href='#' onclick='addPointLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Aschool_points_wgs84&maxFeatures=3451&outputFormat=application%2Fjson\")'><li>Varanasi School Points Data</li></a><a href='#' onclick='addPolygonLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avillage_boundary_wgs84&outputFormat=application%2Fjson\")'><li>Varanasi Village Boundary</li></a><a href='#' onclick='addLineLayerFromSDI(\"http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Avaranasi_roads_wgs84&&outputFormat=application%2Fjson\")'><li>Varanasi Road Network</a></li>";
                return this._div;
            };
            layerAddingDialogBox.addTo(map);

            //Add processing toolbox
            var processingToolbox = L.control({position: 'topright'});

            processingToolbox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'processingtoolbox');
                this._div.id = "processingtoolboxid";
                this._div.innerHTML = "<a href='#' style='text-decoration:none;color:black;' onclick='hideProcessingToolbox();'>Close</a><br><h3>Processing Toolbox</h3><h4>Choose an operation below:</h4>";
                return this._div;
            };
            processingToolbox.addTo(map);

            //Add layer control
            var layerControl = L.control({position: 'bottomleft'});

            layerControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'layers'); // create a div with a class "layers"
                return this._div;
            };
            
            layerControl.addLayer = function (layer,layerName) {
                var currentLayer = this;
                (function (_layerIndex) {
                    currentLayer._div.innerHTML += ('<div class="layer_elements" id="'+ layerIndex +'_layer"><p><b>'+ layerName +'&nbsp;<a href="#" id="'+ layerIndex+"_delete" +'"><img src="images/svg/trash.svg" width=13></img></a>&nbsp;<img src="images/svg/eye.svg" width=13 onClick="toggleVisibility('+ layer +')"></img>&nbsp;<img src="images/svg/save.svg" width=13 onClick="saveLayer('+ layer +')"></img></b></p></div>');
                })(layerIndex);
                layerIndex++;
                layerList.push(layer);
                console.log(layerList);
            };

            layerControl.addTo(map);
            layerControl.addLayer(OSMLayer,"OSM Standard");

            /*async function addWFSLayerFromSDI(url) {
                var geojsonLayer;      
                var markers = [];
                await $.getJSON(url)
                    .then(function (data) {
                        geojsonLayer = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                var marker = L.circleMarker(latlng,{radius:2});
                                //marker.bindPopup(feature.properties.Location + '<br/>' + feature.properties.OPEN_DT);
                                markers.push(marker);
                                return marker;
                            }
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(markers);
                return geojsonLayer;
            }
        
            var geojsonLayer = addWFSLayerFromSDI("http://52.91.190.127:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite%3Aschool_points_wgs84&maxFeatures=3451&outputFormat=application%2Fjson");

            layerControl.addLayer(geojsonLayer,"School Points");*/

            async function addPointLayerFromSDI(url) {
                var geojsonLayer;      
                var markers = [];
                await $.getJSON(url)
                    .then(function (data) {
                        geojsonLayer = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                var marker = L.circleMarker(latlng,{radius:2});
                                //marker.bindPopup(feature.properties.Location + '<br/>' + feature.properties.OPEN_DT);
                                markers.push(marker);
                                return marker;
                            }
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(markers);

                await layerControl.addLayer(geojsonLayer,"Points");
                addOnClickListenersToLayers();
            }

            async function addPolygonLayerFromSDI(url) {
                var geojsonLayer;      
                var polygons = [];
                await $.getJSON(url)
                    .then(function (data) {
                        geojsonLayer = L.geoJson(data, {
                            /*pointToLayer: function (feature, latlng) {
                                var marker = L.circleMarker(latlng,{radius:2});
                                //marker.bindPopup(feature.properties.Location + '<br/>' + feature.properties.OPEN_DT);
                                markers.push(marker);
                                return marker;
                            }*/
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(null);

                await layerControl.addLayer(geojsonLayer,"Polygons");
                addOnClickListenersToLayers();
            }

            async function addLineLayerFromSDI(url) {
                var geojsonLayer;      
                var lines = [];
                await $.getJSON(url)
                    .then(function (data) {
                        geojsonLayer = L.geoJson(data, {
                            /*pointToLayer: function (feature, latlng) {
                                var marker = L.circleMarker(latlng,{radius:2});
                                //marker.bindPopup(feature.properties.Location + '<br/>' + feature.properties.OPEN_DT);
                                markers.push(marker);
                                return marker;
                            }*/
                        }).addTo(map);
                    })
                    .fail(function(err){
                        console.log(err.responseText)
                });
                featureList.push(null);

                await layerControl.addLayer(geojsonLayer,"Lines");
                addOnClickListenersToLayers();
            }

            function addOnClickListenersToLayers() {
                for(i = 0; i <= layerIndex; i++) {
                    deleteButton = document.getElementById(i+"_delete");
                    if (typeof window.addEventListener === 'function'){
                        (function (_deleteButton,_i) {
                            try {
                                deleteButton.addEventListener('click', function(){
                                    swal({
                                        title: "Are you sure you want to delete this layer?",
                                        icon: "warning",
                                        buttons: true,
                                        dangerMode: true,
                                        })
                                        .then((willDelete) => {
                                        if (willDelete) {
                                            map.removeLayer(layerList[_i]);
                                            console.log(featureList[_i]);
                                            if(featureList[_i] != null) {
                                                for(index=0;index < featureList[_i].length;index++) {
                                                    map.removeLayer(featureList[_i][index]);
                                                    //featureList[_i].splice(index,1);
                                                }
                                            }
                                            //featureList.splice(_i,1);
                                            //layerList.splice(_i,1);
                                            //layerIndex--;
                                            var layer = document.getElementById(_i+"_layer").remove();
                                            addOnClickListenersToLayers();
                                            swal("Layer has been deleted", {
                                            icon: "success",
                                            });
                                        }
                                    });
                                });
                        } catch(err) {
                            console.log(err);
                        }
                        })(deleteButton,i);
                    }
                }
        }

        addOnClickListenersToLayers();
            
        </script>
    </body>
</html>